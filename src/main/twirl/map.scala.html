<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
        <title>Heatmaps</title>
        <style>
                #map {
                    height: 90%;
                }

                html, body {
                    height: 100%;
                    margin: 0;
                    padding: 0;
                }
        </style>
    </head>
    <body>

        <div class="dropdown">
            <div class="btn-group">
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButtonRoutes" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Routes
                    </button>
                    <div class="dropdown-menu" id="routes-dropdown-menu" aria-labelledby="dropdownMenuButtonRoutes"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButtonDirections" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Directions
                    </button>
                    <div class="dropdown-menu" id="directions-dropdown-menu" aria-labelledby="dropdownMenuButtonDirections"></div>
                </div>
            </div>
        </div>
        <div id="map"></div>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsL6wsuPFovAUq8STgMIp0xrOqMjv3F6A&libraries=visualization"></script>
        <script src="assets/js/jquery-3.2.1.min.js"></script>
        <script src="assets/js/tether.min.js"></script>
        <script src="assets/js/bootstrap.min.js"></script>
        <script src="assets/js/jquery.easing.1.3.js"></script>
        <script src="assets/js/markerAnimate.js"></script>
        <script src="assets/js/SlidingMarker.min.js"></script>
        <script>
                var map;
                var ws;
                var markerArray = {};

                $(function () {
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: {lat: 51.505485, lng: -0.127889},
                        zoom: 14
                    });
                    openWebsocket("2222");
                });

                function updateWSParams(routeId, direction) {
                    var jsonToSend = '{"busRoutes" : [{"id" : "' + routeId + '","direction" : "' + direction + '"}],' +
                            '"latLngBounds" : {' +
                            '"southwest" : { "lat" : 50.0, "lng" : -1.0 },' +
                            '"northeast" : { "lat" : 53.0, "lng" : 1.0 }' +
                            '}' +
                            '}';
                    sendToWS(jsonToSend)
                }

                function openWebsocket(uuid) {
                    if ("WebSocket" in window) {
                        ws = new WebSocket("ws://34.209.127.7:80/ws?uuid=" + uuid);

                        ws.onopen = function () {
                            updateWSParams("3", "outbound")
                        };

                        ws.onmessage = function (evt) {
                            var json = JSON.parse(evt.data);
                            handleReceivedJson(json)
                        };

                        ws.onclose = function () {
                            alert("Websocket connection is closed...");
                        };

                        window.onbeforeunload = function (event) {
                            socket.close();
                        };
                    }

                    else {
                        alert("WebSockets are NOT supported by your Browser!");
                    }
                }

                function sendToWS(message) {
                    ws.send(message);
                }

                function handleReceivedJson(json) {
                    for (var i = 0; i < json.length; i++) {
                        var vehicleId = json[i].vehicleId;
                        var routeId = json[i].busRoute.id;
                        var direction = json[i].busRoute.direction;
                        var startingStopId = json[i].startingBusStop.stopID;
                        var startingStopLat = json[i].startingBusStop.latLng.lat;
                        var startingStopLng = json[i].startingBusStop.latLng.lng;
                        var startingTimeStamp = json[i].startingTimeStamp;
                        var nextStopName = json[i].nextStopName;
                        var avgTimeToNextStop = json[i].avgTimeToNextStop;
                        var movementInstructionsRaw = json[i].movementInstructionsToNext;

                        if (vehicleId in markerArray) {
                            //TODO
                        } else {
                            var startingLatLng = new google.maps.LatLng(startingStopLat, startingStopLng);
                            markerArray[vehicleId] = createMarker(startingLatLng);
                        }

                        var marker = markerArray[vehicleId];
                        var initialDelayTime = startingTimeStamp - Date.now();
                        var timeAccumulator = initialDelayTime < 0  ? 0 : initialDelayTime;

                        for (var j = 0; j < movementInstructionsRaw.length; i++) {
                            var fromLat = movementInstructionsRaw[j].from.lat;
                            var fromLng = movementInstructionsRaw[j].from.lng;
                            var toLat = movementInstructionsRaw[j].to.lat;
                            var toLng = movementInstructionsRaw[j].to.lng;
                            var angle = movementInstructionsRaw[j].angle;
                            var proportionalDistance = movementInstructionsRaw[j].proportionalDistance;

                            var latLngToMoveTo = new google.maps.LatLng(toLat, toLng);
                            var proportionalTime = avgTimeToNextStop * proportionalDistance;

                            animateMarker(marker, proportionalTime, latLngToMoveTo, timeAccumulator);

                            timeAccumulator += proportionalTime
                        }
                    }
                }

                function createMarker(latLng) {
                    return new google.maps.Marker({
                        position: latLng,
                        //icon: iconArray[reg],
                        map: map,
                        visible: true
                    })
                }

                function animateMarker(marker, duration, moveTo, waitTime) {

                    setTimeout(function () {
//                        var routeIDOffset = routeID.length * 5.5;
//                        iconArray[reg].rotation = rotation;

//                        if (timeOut > 0) {
//                            markerArray[reg].setVisible(true);
//                        }
                        marker.setDuration(duration);
//                        markerArray[vehicleId].setIcon(iconArray[reg]);
//                        markerArray[reg].labelAnchor = new google.maps.Point(routeIDOffset, 10);
//                        markerArray[reg].label.setStyles();
                        marker.setPosition(moveTo);
                    }, waitTime);
                }
        </script>
    </body>
</html>